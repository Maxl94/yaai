name: yaai-e2e-test

services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: aimon
      POSTGRES_PASSWORD: testpass
      POSTGRES_DB: aimonitoring_test
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aimon -d aimonitoring_test"]
      interval: 3s
      timeout: 3s
      retries: 10

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8001:8000"
    environment:
      DATABASE_URL: postgresql+asyncpg://aimon:testpass@db:5432/aimonitoring_test
      DATABASE_URL_SYNC: postgresql://aimon:testpass@db:5432/aimonitoring_test
      AUTH_ENABLED: "true"
      AUTH_JWT_SECRET: "e2e-test-jwt-secret-32chars-long!"
      AUTH_JWT_ALGORITHM: "HS256"
      AUTH_LOCAL_ENABLED: "true"
      AUTH_LOCAL_ALLOW_REGISTRATION: "false"
      AUTH_SERVICE_ACCOUNTS_API_KEYS_ENABLED: "true"
      AUTH_OAUTH_GOOGLE_ENABLED: "false"
      SESSION_SECRET: "e2e-test-session-secret"
      RATE_LIMIT_ENABLED: "false"
      CORS_ALLOWED_ORIGINS: "http://localhost:8001"
    depends_on:
      db:
        condition: service_healthy
